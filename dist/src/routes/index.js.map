{"version":3,"sources":["../../../src/routes/index.js"],"names":["router","Router","dbo","mongo_url","Storage","diskStorage","destination","req","file","callback","filename","fieldname","Date","now","originalname","upload","storage","single","authorise","res","next","session","auth","authUser","getDatasetsWithCounts","datasets","render","username","isAdmin","get","post","checkAuth","body","name","password","status","user","userId","_id","console","log","err","output","json","JSON","stringify","html","checkIfUserExists","result","addUser","addDataset","desc","dataset","dataset_id","path","existsSync","mkdirSync","size","width","height","rename","addDatasetImage","sendStatus","getNextDatasetImage","datasetImage","getProblems","problems","getOneDatasetsWithCounts","datasetImage_id","countTagged","countAll","src","addTag","tag","send","addProblem","problem_id","destroy"],"mappings":"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","file":"index.js","sourcesContent":["import express from 'express';\r\nimport multer from 'multer';\r\nimport fs from 'fs';\r\nimport sizeOf from 'image-size';\r\n\r\nimport DBO from '../models/DBO'\r\nimport config from '../config'\r\n\r\nlet router = express.Router();\r\nlet dbo = new DBO(config.mongo_url);\r\n\r\n\r\nlet Storage = multer.diskStorage({\r\n    destination: function(req, file, callback) {\r\n        callback(null, \"dataset-images\");\r\n    },\r\n\r\n    filename: function(req, file, callback) {\r\n        const filename = file.fieldname + \"_\" + Date.now() + \"_\" + file.originalname;\r\n        callback(null, filename);\r\n    }\r\n});\r\n\r\nlet upload = multer({\r\n    storage: Storage\r\n}).single('file');\r\n\r\n\r\n\r\nlet authorise = function(req, res, next) {\r\n    if(req.session.auth && req.session.authUser) {\r\n        dbo.getDatasetsWithCounts((datasets) => {\r\n            res.render('panel', { username: req.session.authUser, isAdmin: req.session.isAdmin, datasets: datasets});\r\n        });\r\n    }\r\n    else {\r\n        next();\r\n    }\r\n}\r\n\r\nrouter.get('/', authorise, (req, res) => {\r\n    res.render(\"login\");\r\n});\r\n\r\nrouter.get('/register', authorise, (req, res) => {\r\n    res.render(\"register\");\r\n});\r\n\r\nrouter.post(\"/login\", authorise, (req, res, next) => {\r\n    if(dbo.checkAuth(req.body.name, req.body.password, (status, user) => {\r\n            if(status) {\r\n                req.session.auth = true;\r\n                req.session.authUser = user.name;\r\n                req.session.isAdmin = user.isAdmin;\r\n                req.session.userId = user._id;\r\n\r\n                console.log(\"auth ok - \" + req.session.authUser);\r\n\r\n                dbo.getDatasetsWithCounts((datasets) => {\r\n                    res.render('panel-partial', { username: user.name, isAdmin: user.isAdmin, datasets: datasets},\r\n                        function (err, output) {\r\n                            console.log(\"res\");\r\n                            res.json(JSON.stringify({ status: \"true\", html: output }));\r\n                        });\r\n                });\r\n            }\r\n            else {\r\n                res.json(JSON.stringify({status: \"false\"}));\r\n            }\r\n        }));\r\n});\r\n\r\nrouter.post(\"/new-register\", authorise, (req, res, next) => {\r\n    dbo.checkIfUserExists(req.body.name, (result) => {\r\n        if(!result) {\r\n            dbo.addUser(req.body.name, req.body.password, false, (status) => {\r\n                res.render('register-confirm', { status: status }, (err, output) => {\r\n                    res.json(JSON.stringify({ html: output }));\r\n                });\r\n            });\r\n        }\r\n        else {\r\n            res.json(JSON.stringify({ status: \"user-exists\", html: null }));\r\n        }\r\n    });\r\n});\r\n\r\n\r\n/*\r\n\r\n    Panel\r\n\r\n */\r\n\r\nrouter.post('/open-add-dataset', (req, res) => {\r\n    res.render('add-dataset', (err, output) => {\r\n        res.json(JSON.stringify({ html: output }));\r\n    });\r\n});\r\n\r\nrouter.post('/add-dataset', (req, res) => {\r\n    dbo.addDataset(req.body.name, req.body.desc, (status, dataset) => {\r\n        if(status) {\r\n            res.json(JSON.stringify({ status: \"true\", dataset_id: dataset._id}));\r\n        }\r\n    });\r\n});\r\n\r\nrouter.post(\"/add-dataset-image\", (req, res) =>  {\r\n    upload(req, res, function(err) {\r\n        if (err) {\r\n            console.log(err);\r\n        }\r\n        else {\r\n            const path = \"dataset-images/\" + req.body.dataset_id;\r\n            if (!fs.existsSync(path)){\r\n                fs.mkdirSync(path);\r\n            }\r\n\r\n            sizeOf(req.file.path, (err, size) => {\r\n                if (!err) {\r\n                    console.log('width = ' + size.width);\r\n                    console.log('height = ' + size.height);\r\n\r\n                    console.log(req.file.path + \" => \" + path + \" - \" + req.file.filename);\r\n\r\n                    fs.rename(req.file.path, path + \"/\" + req.file.filename, (err) => {\r\n                        if(err) throw err;\r\n                        else console.log('Successfully moved');\r\n                    });\r\n\r\n                    dbo.addDatasetImage(path + \"/\" + req.file.filename, req.body.dataset_id,\r\n                        size.width, size.height, (status) => {});\r\n\r\n\r\n                    res.sendStatus(200);\r\n\r\n                } else {\r\n                    console.log(\"Problem z określaniem rozmiaru - \" + err);\r\n                }\r\n            });\r\n\r\n\r\n        }\r\n    });\r\n});\r\n\r\nrouter.post(\"/get-datasets\", (req, res) => {\r\n    dbo.getDatasetsWithCounts((datasets) => {\r\n        res.render('datasets-partial', { datasets: datasets }, (err, output) => {\r\n            res.json(JSON.stringify({ html: output }));\r\n        });\r\n    });\r\n});\r\n\r\nrouter.post(\"/get-dataset-image\", (req, res) => {\r\n    dbo.getNextDatasetImage(req.body.dataset_id, (datasetImage) => {\r\n        if(datasetImage == null) {\r\n            console.log(\"koniec datasetu\");\r\n            res.sendStatus(404);\r\n        }\r\n        else {\r\n            dbo.getProblems((problems) => {\r\n                dbo.getOneDatasetsWithCounts(req.body.dataset_id, (dataset) => {\r\n                    res.render('tagging', {\r\n                        dataset: dataset.name,\r\n                        datasetImage_id: datasetImage._id,\r\n                        path: datasetImage.path,\r\n                        countTagged: dataset.countTagged,\r\n                        countAll: dataset.countAll,\r\n                        problems: problems\r\n                    }, (err, output) => {\r\n                        res.json(JSON.stringify({ src: datasetImage.path, width: datasetImage.width,\r\n                            height: datasetImage.height, html: output }));\r\n                    });\r\n                });\r\n            });\r\n        }\r\n\r\n    });\r\n});\r\n\r\n// sprawdzać czy jest już otagowany\r\nrouter.post(\"/add-tag\", (req, res) => {\r\n    dbo.addTag(req.body.datasetImage_id, req.session.userId, req.body.tag, (status) => {\r\n        if(status)\r\n            res.send(\"true\");\r\n    });\r\n});\r\n\r\nrouter.post(\"/add-problem\", (req, res) => {\r\n    dbo.addProblem(req.body.datasetImage_id, req.session.userId, req.body.problem_id, (status) => {\r\n        if(status)\r\n            res.send(\"true\");\r\n    });\r\n});\r\n\r\nrouter.post(\"/logout\", (req, res) => {\r\n    console.log(\"logout\");\r\n\r\n    req.session.destroy();\r\n    res.render('login-partial', (err, output) => {\r\n        res.json(JSON.stringify({ status: \"true\", html: output }));\r\n    });\r\n});\r\n\r\n\r\nexport default router;"]}