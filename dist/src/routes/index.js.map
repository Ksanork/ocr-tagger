{"version":3,"sources":["../../../src/routes/index.js"],"names":["router","Router","dbo","mongo_url","Storage","diskStorage","destination","req","file","callback","filename","fieldname","Date","now","originalname","upload","storage","single","authorise","res","next","session","auth","authUser","getDatasetsWithCounts","datasets","forEach","elem","console","log","countTagged","countAll","render","username","isAdmin","get","post","checkAuth","body","name","password","status","user","userId","_id","err","output","json","JSON","stringify","html","checkIfUserExists","result","addUser","addDataset","desc","dataset","dataset_id","path","existsSync","mkdirSync","size","width","height","rename","addDatasetImage","sendStatus","getNextDatasetImage","datasetImage","getOneDatasetsWithCounts","datasetImage_id","src","addTag","tag","send","destroy"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AAEA;;;;AACA;;;;;;AAEA,IAAIA,SAAS,kBAAQC,MAAR,EAAb;AACA,IAAIC,MAAM,kBAAQ,iBAAOC,SAAf,CAAV;;AAGA,IAAIC,UAAU,iBAAOC,WAAP,CAAmB;AAC7BC,iBAAa,qBAASC,GAAT,EAAcC,IAAd,EAAoBC,QAApB,EAA8B;AACvCA,iBAAS,IAAT,EAAe,gBAAf;AACH,KAH4B;;AAK7BC,cAAU,kBAASH,GAAT,EAAcC,IAAd,EAAoBC,QAApB,EAA8B;AACpC,YAAMC,WAAWF,KAAKG,SAAL,GAAiB,GAAjB,GAAuBC,KAAKC,GAAL,EAAvB,GAAoC,GAApC,GAA0CL,KAAKM,YAAhE;AACAL,iBAAS,IAAT,EAAeC,QAAf;AACH;AAR4B,CAAnB,CAAd;;AAWA,IAAIK,SAAS,sBAAO;AAChBC,aAASZ;AADO,CAAP,EAEVa,MAFU,CAEH,MAFG,CAAb;;AAMA,IAAIC,YAAY,SAAZA,SAAY,CAASX,GAAT,EAAcY,GAAd,EAAmBC,IAAnB,EAAyB;AACrC,QAAGb,IAAIc,OAAJ,CAAYC,IAAZ,IAAoBf,IAAIc,OAAJ,CAAYE,QAAnC,EAA6C;;AAGzC;;AAEArB,YAAIsB,qBAAJ,CAA0B,UAACC,QAAD,EAAc;AACpCA,qBAASC,OAAT,CAAiB,UAACC,IAAD,EAAU;AACvBC,wBAAQC,GAAR,CAAY,SAASF,KAAKG,WAAd,GAA4B,KAA5B,GAAoCH,KAAKI,QAArD;AACH,aAFD;;AAIAZ,gBAAIa,MAAJ,CAAW,OAAX,EAAoB,EAAEC,UAAU1B,IAAIc,OAAJ,CAAYE,QAAxB,EAAkCW,SAAS3B,IAAIc,OAAJ,CAAYa,OAAvD,EAAgET,UAAUA,QAA1E,EAApB;AACH,SAND;;AASA;AACA;AACH,KAhBD,MAiBK;AACDL;AACH;AACJ,CArBD;;AAuBApB,OAAOmC,GAAP,CAAW,GAAX,EAAgBjB,SAAhB,EAA2B,UAACX,GAAD,EAAMY,GAAN,EAAc;AACrCA,QAAIa,MAAJ,CAAW,OAAX;AACH,CAFD;;AAIAhC,OAAOmC,GAAP,CAAW,WAAX,EAAwBjB,SAAxB,EAAmC,UAACX,GAAD,EAAMY,GAAN,EAAc;AAC7CA,QAAIa,MAAJ,CAAW,UAAX;AACH,CAFD;;AAIAhC,OAAOoC,IAAP,CAAY,QAAZ,EAAsBlB,SAAtB,EAAiC,UAACX,GAAD,EAAMY,GAAN,EAAWC,IAAX,EAAoB;AACjD,QAAGlB,IAAImC,SAAJ,CAAc9B,IAAI+B,IAAJ,CAASC,IAAvB,EAA6BhC,IAAI+B,IAAJ,CAASE,QAAtC,EAAgD,UAACC,MAAD,EAASC,IAAT,EAAkB;AAC7D,YAAGD,MAAH,EAAW;AACPlC,gBAAIc,OAAJ,CAAYC,IAAZ,GAAmB,IAAnB;AACAf,gBAAIc,OAAJ,CAAYE,QAAZ,GAAuBmB,KAAKH,IAA5B;AACAhC,gBAAIc,OAAJ,CAAYa,OAAZ,GAAsBQ,KAAKR,OAA3B;AACA3B,gBAAIc,OAAJ,CAAYsB,MAAZ,GAAqBD,KAAKE,GAA1B;;AAEAhB,oBAAQC,GAAR,CAAY,eAAetB,IAAIc,OAAJ,CAAYE,QAAvC;;AAEArB,gBAAIsB,qBAAJ,CAA0B,UAACC,QAAD,EAAc;AACpCA,yBAASC,OAAT,CAAiB,UAACC,IAAD,EAAU;AACvBC,4BAAQC,GAAR,CAAY,SAASF,KAAKG,WAAd,GAA4B,KAA5B,GAAoCH,KAAKI,QAArD;AACH,iBAFD;;AAIAZ,oBAAIa,MAAJ,CAAW,eAAX,EAA4B,EAAEC,UAAUS,KAAKH,IAAjB,EAAuBL,SAASQ,KAAKR,OAArC,EAA8CT,UAAUA,QAAxD,EAA5B,EACI,UAAUoB,GAAV,EAAeC,MAAf,EAAuB;AACnBlB,4BAAQC,GAAR,CAAY,KAAZ;AACAV,wBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAER,QAAQ,MAAV,EAAkBS,MAAMJ,MAAxB,EAAf,CAAT;AACH,iBAJL;AAKH,aAVD;AAWH,SAnBD,MAoBK;AACD3B,gBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAACR,QAAQ,OAAT,EAAf,CAAT;AACH;AACJ,KAxBF,CAAH,EAwBO;AACV,CA1BD;;AA4BAzC,OAAOoC,IAAP,CAAY,eAAZ,EAA6BlB,SAA7B,EAAwC,UAACX,GAAD,EAAMY,GAAN,EAAWC,IAAX,EAAoB;AACxDlB,QAAIiD,iBAAJ,CAAsB5C,IAAI+B,IAAJ,CAASC,IAA/B,EAAqC,UAACa,MAAD,EAAY;AAC7C,YAAG,CAACA,MAAJ,EAAY;AACRlD,gBAAImD,OAAJ,CAAY9C,IAAI+B,IAAJ,CAASC,IAArB,EAA2BhC,IAAI+B,IAAJ,CAASE,QAApC,EAA8C,KAA9C,EAAqD,UAACC,MAAD,EAAY;AAC7DtB,oBAAIa,MAAJ,CAAW,kBAAX,EAA+B,EAAES,QAAQA,MAAV,EAA/B,EAAmD,UAACI,GAAD,EAAMC,MAAN,EAAiB;AAChE3B,wBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAEC,MAAMJ,MAAR,EAAf,CAAT;AACH,iBAFD;AAGH,aAJD;AAKH,SAND,MAOK;AACD3B,gBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAER,QAAQ,aAAV,EAAyBS,MAAM,IAA/B,EAAf,CAAT;AACH;AACJ,KAXD;AAYH,CAbD;;AAgBA;;;;;;AAMAlD,OAAOoC,IAAP,CAAY,mBAAZ,EAAiC,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AAC3CA,QAAIa,MAAJ,CAAW,aAAX,EAA0B,UAACa,GAAD,EAAMC,MAAN,EAAiB;AACvC3B,YAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAEC,MAAMJ,MAAR,EAAf,CAAT;AACH,KAFD;AAGH,CAJD;;AAMA9C,OAAOoC,IAAP,CAAY,cAAZ,EAA4B,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AACtCjB,QAAIoD,UAAJ,CAAe/C,IAAI+B,IAAJ,CAASC,IAAxB,EAA8BhC,IAAI+B,IAAJ,CAASiB,IAAvC,EAA6C,UAACd,MAAD,EAASe,OAAT,EAAqB;AAC9D,YAAGf,MAAH,EAAW;AACPtB,gBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAER,QAAQ,MAAV,EAAkBgB,YAAYD,QAAQZ,GAAtC,EAAf,CAAT;AACH;AACJ,KAJD;AAKH,CAND;;AAQA5C,OAAOoC,IAAP,CAAY,oBAAZ,EAAkC,UAAC7B,GAAD,EAAMY,GAAN,EAAe;AAC7CJ,WAAOR,GAAP,EAAYY,GAAZ,EAAiB,UAAS0B,GAAT,EAAc;AAC3B,YAAIA,GAAJ,EAAS;AACLjB,oBAAQC,GAAR,CAAYgB,GAAZ;AACH,SAFD,MAGK;AACD,gBAAMa,OAAO,oBAAoBnD,IAAI+B,IAAJ,CAASmB,UAA1C;AACA,gBAAI,CAAC,aAAGE,UAAH,CAAcD,IAAd,CAAL,EAAyB;AACrB,6BAAGE,SAAH,CAAaF,IAAb;AACH;;AAED,qCAAOnD,IAAIC,IAAJ,CAASkD,IAAhB,EAAsB,UAACb,GAAD,EAAMgB,IAAN,EAAe;AACjC,oBAAI,CAAChB,GAAL,EAAU;AACNjB,4BAAQC,GAAR,CAAY,aAAagC,KAAKC,KAA9B;AACAlC,4BAAQC,GAAR,CAAY,cAAcgC,KAAKE,MAA/B;;AAEAnC,4BAAQC,GAAR,CAAYtB,IAAIC,IAAJ,CAASkD,IAAT,GAAgB,MAAhB,GAAyBA,IAAzB,GAAgC,KAAhC,GAAwCnD,IAAIC,IAAJ,CAASE,QAA7D;;AAEA,iCAAGsD,MAAH,CAAUzD,IAAIC,IAAJ,CAASkD,IAAnB,EAAyBA,OAAO,GAAP,GAAanD,IAAIC,IAAJ,CAASE,QAA/C,EAAyD,UAACmC,GAAD,EAAS;AAC9D,4BAAGA,GAAH,EAAQ,MAAMA,GAAN,CAAR,KACKjB,QAAQC,GAAR,CAAY,oBAAZ;AACR,qBAHD;;AAKA3B,wBAAI+D,eAAJ,CAAoBP,OAAO,GAAP,GAAanD,IAAIC,IAAJ,CAASE,QAA1C,EAAoDH,IAAI+B,IAAJ,CAASmB,UAA7D,EACII,KAAKC,KADT,EACgBD,KAAKE,MADrB,EAC6B,UAACtB,MAAD,EAAY,CAAE,CAD3C;;AAIAtB,wBAAI+C,UAAJ,CAAe,GAAf;AAEH,iBAjBD,MAiBO;AACHtC,4BAAQC,GAAR,CAAY,sCAAsCgB,GAAlD;AACH;AACJ,aArBD;AAwBH;AACJ,KAnCD;AAoCH,CArCD;;AAuCA7C,OAAOoC,IAAP,CAAY,eAAZ,EAA6B,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AACvCjB,QAAIsB,qBAAJ,CAA0B,UAACC,QAAD,EAAc;AACpCA,iBAASC,OAAT,CAAiB,UAACC,IAAD,EAAU;AACvBC,oBAAQC,GAAR,CAAY,SAASF,KAAKG,WAAd,GAA4B,KAA5B,GAAoCH,KAAKI,QAArD;AACH,SAFD;;AAIAZ,YAAIa,MAAJ,CAAW,kBAAX,EAA+B,EAAEP,UAAUA,QAAZ,EAA/B,EAAuD,UAACoB,GAAD,EAAMC,MAAN,EAAiB;AACpE;;AAEA3B,gBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAEC,MAAMJ,MAAR,EAAf,CAAT;AACH,SAJD;AAKH,KAVD;AAWH,CAZD;;AAcA9C,OAAOoC,IAAP,CAAY,oBAAZ,EAAkC,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AAC5CjB,QAAIiE,mBAAJ,CAAwB5D,IAAI+B,IAAJ,CAASmB,UAAjC,EAA6C,UAACW,YAAD,EAAkB;AAC3D,YAAGA,gBAAgB,IAAnB,EAAyB;AACrBxC,oBAAQC,GAAR,CAAY,iBAAZ;AACAV,gBAAI+C,UAAJ,CAAe,GAAf;AACH,SAHD,MAIK;AACDhE,gBAAImE,wBAAJ,CAA6B9D,IAAI+B,IAAJ,CAASmB,UAAtC,EAAkD,UAACD,OAAD,EAAa;AAC3DrC,oBAAIa,MAAJ,CAAW,SAAX,EAAsB;AAClBwB,6BAASA,QAAQjB,IADC;AAElB+B,qCAAiBF,aAAaxB,GAFZ;AAGlBc,0BAAMU,aAAaV,IAHD;AAIlB5B,iCAAa0B,QAAQ1B,WAJH;AAKlBC,8BAAUyB,QAAQzB;AALA,iBAAtB,EAMG,UAACc,GAAD,EAAMC,MAAN,EAAiB;AAChB3B,wBAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAEsB,KAAKH,aAAaV,IAApB,EAA0BI,OAAOM,aAAaN,KAA9C;AACpBC,gCAAQK,aAAaL,MADD,EACSb,MAAMJ,MADf,EAAf,CAAT;AAEH,iBATD;AAUH,aAXD;AAYH;AAEJ,KApBD;AAqBH,CAtBD;;AAwBA;AACA9C,OAAOoC,IAAP,CAAY,UAAZ,EAAwB,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AAClCjB,QAAIsE,MAAJ,CAAWjE,IAAI+B,IAAJ,CAASgC,eAApB,EAAqC/D,IAAIc,OAAJ,CAAYsB,MAAjD,EAAyDpC,IAAI+B,IAAJ,CAASmC,GAAlE,EAAuE,UAAChC,MAAD,EAAY;AAC/E,YAAGA,MAAH,EACItB,IAAIuD,IAAJ,CAAS,MAAT;AACP,KAHD;AAIH,CALD;;AAOA1E,OAAOoC,IAAP,CAAY,SAAZ,EAAuB,UAAC7B,GAAD,EAAMY,GAAN,EAAc;AACjCS,YAAQC,GAAR,CAAY,QAAZ;;AAEAtB,QAAIc,OAAJ,CAAYsD,OAAZ;AACAxD,QAAIa,MAAJ,CAAW,eAAX,EAA4B,UAACa,GAAD,EAAMC,MAAN,EAAiB;AACzC3B,YAAI4B,IAAJ,CAASC,KAAKC,SAAL,CAAe,EAAER,QAAQ,MAAV,EAAkBS,MAAMJ,MAAxB,EAAf,CAAT;AACH,KAFD;AAGH,CAPD;;kBAUe9C,M","file":"index.js","sourcesContent":["import express from 'express';\r\nimport multer from 'multer';\r\nimport fs from 'fs';\r\nimport sizeOf from 'image-size';\r\n\r\nimport DBO from '../models/DBO'\r\nimport config from '../config'\r\n\r\nlet router = express.Router();\r\nlet dbo = new DBO(config.mongo_url);\r\n\r\n\r\nlet Storage = multer.diskStorage({\r\n    destination: function(req, file, callback) {\r\n        callback(null, \"dataset-images\");\r\n    },\r\n\r\n    filename: function(req, file, callback) {\r\n        const filename = file.fieldname + \"_\" + Date.now() + \"_\" + file.originalname;\r\n        callback(null, filename);\r\n    }\r\n});\r\n\r\nlet upload = multer({\r\n    storage: Storage\r\n}).single('file');\r\n\r\n\r\n\r\nlet authorise = function(req, res, next) {\r\n    if(req.session.auth && req.session.authUser) {\r\n\r\n\r\n        // let datasets =  dbo.getDatasetsWithCounts2();\r\n\r\n        dbo.getDatasetsWithCounts((datasets) => {\r\n            datasets.forEach((elem) => {\r\n                console.log(\"get \" + elem.countTagged + \" / \" + elem.countAll);\r\n            });\r\n\r\n            res.render('panel', { username: req.session.authUser, isAdmin: req.session.isAdmin, datasets: datasets});\r\n        });\r\n\r\n\r\n        // next();\r\n        // res.render(\"panel\", { username: req.session.authUser, isAdmin: req.session.isAdmin });\r\n    }\r\n    else {\r\n        next();\r\n    }\r\n}\r\n\r\nrouter.get('/', authorise, (req, res) => {\r\n    res.render(\"login\");\r\n});\r\n\r\nrouter.get('/register', authorise, (req, res) => {\r\n    res.render(\"register\");\r\n});\r\n\r\nrouter.post(\"/login\", authorise, (req, res, next) => {\r\n    if(dbo.checkAuth(req.body.name, req.body.password, (status, user) => {\r\n            if(status) {\r\n                req.session.auth = true;\r\n                req.session.authUser = user.name;\r\n                req.session.isAdmin = user.isAdmin;\r\n                req.session.userId = user._id;\r\n\r\n                console.log(\"auth ok - \" + req.session.authUser);\r\n\r\n                dbo.getDatasetsWithCounts((datasets) => {\r\n                    datasets.forEach((elem) => {\r\n                        console.log(\"get \" + elem.countTagged + \" / \" + elem.countAll);\r\n                    });\r\n\r\n                    res.render('panel-partial', { username: user.name, isAdmin: user.isAdmin, datasets: datasets},\r\n                        function (err, output) {\r\n                            console.log(\"res\");\r\n                            res.json(JSON.stringify({ status: \"true\", html: output }));\r\n                        });\r\n                });\r\n            }\r\n            else {\r\n                res.json(JSON.stringify({status: \"false\"}));\r\n            }\r\n        }));\r\n});\r\n\r\nrouter.post(\"/new-register\", authorise, (req, res, next) => {\r\n    dbo.checkIfUserExists(req.body.name, (result) => {\r\n        if(!result) {\r\n            dbo.addUser(req.body.name, req.body.password, false, (status) => {\r\n                res.render('register-confirm', { status: status }, (err, output) => {\r\n                    res.json(JSON.stringify({ html: output }));\r\n                });\r\n            });\r\n        }\r\n        else {\r\n            res.json(JSON.stringify({ status: \"user-exists\", html: null }));\r\n        }\r\n    });\r\n});\r\n\r\n\r\n/*\r\n\r\n    Panel\r\n\r\n */\r\n\r\nrouter.post('/open-add-dataset', (req, res) => {\r\n    res.render('add-dataset', (err, output) => {\r\n        res.json(JSON.stringify({ html: output }));\r\n    });\r\n});\r\n\r\nrouter.post('/add-dataset', (req, res) => {\r\n    dbo.addDataset(req.body.name, req.body.desc, (status, dataset) => {\r\n        if(status) {\r\n            res.json(JSON.stringify({ status: \"true\", dataset_id: dataset._id}));\r\n        }\r\n    });\r\n});\r\n\r\nrouter.post(\"/add-dataset-image\", (req, res) =>  {\r\n    upload(req, res, function(err) {\r\n        if (err) {\r\n            console.log(err);\r\n        }\r\n        else {\r\n            const path = \"dataset-images/\" + req.body.dataset_id;\r\n            if (!fs.existsSync(path)){\r\n                fs.mkdirSync(path);\r\n            }\r\n\r\n            sizeOf(req.file.path, (err, size) => {\r\n                if (!err) {\r\n                    console.log('width = ' + size.width);\r\n                    console.log('height = ' + size.height);\r\n\r\n                    console.log(req.file.path + \" => \" + path + \" - \" + req.file.filename);\r\n\r\n                    fs.rename(req.file.path, path + \"/\" + req.file.filename, (err) => {\r\n                        if(err) throw err;\r\n                        else console.log('Successfully moved');\r\n                    });\r\n\r\n                    dbo.addDatasetImage(path + \"/\" + req.file.filename, req.body.dataset_id,\r\n                        size.width, size.height, (status) => {});\r\n\r\n\r\n                    res.sendStatus(200);\r\n\r\n                } else {\r\n                    console.log(\"Problem z określaniem rozmiaru - \" + err);\r\n                }\r\n            });\r\n\r\n\r\n        }\r\n    });\r\n});\r\n\r\nrouter.post(\"/get-datasets\", (req, res) => {\r\n    dbo.getDatasetsWithCounts((datasets) => {\r\n        datasets.forEach((elem) => {\r\n            console.log(\"get \" + elem.countTagged + \" / \" + elem.countAll);\r\n        });\r\n\r\n        res.render('datasets-partial', { datasets: datasets }, (err, output) => {\r\n            // console.log(\"get \" + da)\r\n\r\n            res.json(JSON.stringify({ html: output }));\r\n        });\r\n    });\r\n});\r\n\r\nrouter.post(\"/get-dataset-image\", (req, res) => {\r\n    dbo.getNextDatasetImage(req.body.dataset_id, (datasetImage) => {\r\n        if(datasetImage == null) {\r\n            console.log(\"koniec datasetu\");\r\n            res.sendStatus(404);\r\n        }\r\n        else {\r\n            dbo.getOneDatasetsWithCounts(req.body.dataset_id, (dataset) => {\r\n                res.render('tagging', {\r\n                    dataset: dataset.name,\r\n                    datasetImage_id: datasetImage._id,\r\n                    path: datasetImage.path,\r\n                    countTagged: dataset.countTagged,\r\n                    countAll: dataset.countAll\r\n                }, (err, output) => {\r\n                    res.json(JSON.stringify({ src: datasetImage.path, width: datasetImage.width,\r\n                        height: datasetImage.height, html: output }));\r\n                });\r\n            });\r\n        }\r\n\r\n    });\r\n});\r\n\r\n// sprawdzać czy jest już otagowany\r\nrouter.post(\"/add-tag\", (req, res) => {\r\n    dbo.addTag(req.body.datasetImage_id, req.session.userId, req.body.tag, (status) => {\r\n        if(status)\r\n            res.send(\"true\");\r\n    });\r\n});\r\n\r\nrouter.post(\"/logout\", (req, res) => {\r\n    console.log(\"logout\");\r\n\r\n    req.session.destroy();\r\n    res.render('login-partial', (err, output) => {\r\n        res.json(JSON.stringify({ status: \"true\", html: output }));\r\n    });\r\n});\r\n\r\n\r\nexport default router;"]}